{% extends "withnav_template.html" %}
{% from "components/banner.html" import banner_wrapper %}
{% from "components/table.html" import mapping_table, row, settings_row, text_field, optional_text_field, edit_field, field, boolean_field with context %}

{% block service_page_title %}
  Settings
{% endblock %}

{% block maincolumn_content %}

    <h1 class="heading-large">Settings</h1>

    <div class="bottom-gutter-3-2 dashboard-table body-copy-table">

      {% call mapping_table(
        caption='General',
        field_headings=['Label', 'Value', 'Action'],
        field_headings_visible=False,
        caption_visible=False
      ) %}

        {% call row() %}
          {{ text_field('Service name') }}
          {{ text_field(current_service.name) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_name_change'),
              permissions=['manage_service']
            )
          }}
        {% endcall %}

        {% call row() %}
          {{ text_field('Sign-in method') }}
          {{ text_field(
            'Email link or text message code'
            if 'email_auth' in current_service.permissions
            else 'Text message code'
          ) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_set_auth_type'),
              permissions=['manage_service']
            )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='upload_document') %}
          {{ text_field('Contact details') }}
          {{ text_field(current_service.contact_link, truncate=true) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_set_contact_link'),
              permissions=['manage_service']
            )
          }}
        {% endcall %}

      {% endcall %}

      {% call mapping_table(
        caption='Email',
        field_headings=['Label', 'Value', 'Action'],
        field_headings_visible=False,
        caption_visible=True
      ) %}

        {% call row() %}
          {{ text_field('Send emails') }}
          {{ boolean_field('email' in current_service.permissions) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_set_email'),
              permissions=['manage_service']
              )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='email') %}
          {{ text_field('Email reply-to addresses') }}
          {% call field(status='default' if default_reply_to_email_address == None else '') %}
            {{ current_service.default_email_reply_to_address or 'Not set' }}
            {% if current_service.count_email_reply_to_addresses > 1 %}
              <div class="hint">
                {{ '…and %d more' | format(current_service.count_email_reply_to_addresses - 1) }}
              </div>
            {% endif %}
          {% endcall %}
          {{ edit_field(
              'Manage' if current_service.count_email_reply_to_addresses else 'Change',
              current_service.url_for('.service_email_reply_to'),
              permissions=['manage_service','manage_api_keys']
            )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='email') %}
          {{ text_field('Email branding') }}
          {{ text_field('Your branding' if current_service.email_branding else 'GOV.UK') }}
          {{ edit_field(
            'Change',
            current_service.url_for('.branding_request'),
            permissions=['manage_service'],
          )}}
        {% endcall %}

      {% endcall %}

      {% call mapping_table(
        caption='Text messages',
        field_headings=['Label', 'Value', 'Action'],
        field_headings_visible=False,
        caption_visible=True
      ) %}

        {% call row() %}
          {{ text_field('Send text messages') }}
          {{ boolean_field('sms' in current_service.permissions) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_set_sms'),
              permissions=['manage_service']
            )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='sms') %}
          {{ text_field('Text message sender') }}
          {% call field(status='default' if current_service.default_sms_sender == "None" else '') %}
            {{ current_service.default_sms_sender | string | nl2br | safe if current_service.default_sms_sender else 'None'}}
            {% if current_service.count_sms_senders > 1 %}
              <div class="hint">
                {{ '…and %d more' | format(current_service.count_sms_senders - 1) }}
              </div>
            {% endif %}
          {% endcall %}
          {{ edit_field(
              'Manage' if current_service.count_sms_senders > 1 else 'Change',
              current_service.url_for('.service_sms_senders'),
              permissions=['manage_service','manage_api_keys']
          )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='sms') %}
          {{ text_field('Text messages start with service name') }}
          {{ boolean_field(current_service.prefix_sms) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_set_sms_prefix'),
              permissions=['manage_service']
          )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='sms') %}
          {{ text_field('International text messages') }}
          {{ boolean_field('international_sms' in current_service.permissions) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_set_international_sms'),
              permissions=['manage_service']
          )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='sms') %}
          {{ text_field('Receive text messages') }}
          {{ boolean_field('inbound_sms' in current_service.permissions) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_set_inbound_sms'),
              permissions=['manage_service']
          )
          }}
        {% endcall %}

      {% endcall %}

      {% call mapping_table(
        caption='Letters',
        field_headings=['Label', 'Value', 'Action'],
        field_headings_visible=False,
        caption_visible=True
      ) %}

        {% call row() %}
          {{ text_field('Send letters') }}
          {{ boolean_field('letter' in current_service.permissions) }}
          {{ edit_field(
              'Change',
              current_service.url_for('.service_set_letters'),
              permissions=['manage_service']
          )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='letter') %}
          {{ text_field('Sender addresses') }}
          {% call field(status='default' if current_service.default_letter_contact_block == None else '') %}
            {{ current_service.default_letter_contact_block | string | nl2br | safe if current_service.default_letter_contact_block else 'Not set'}}
            {% if current_service.count_letter_contact_details > 1 %}
              <div class="hint">
                {{ '…and %d more' | format(current_service.count_letter_contact_details - 1) }}
              </div>
            {% endif %}
          {% endcall %}
          {{ edit_field(
              'Manage' if current_service.count_letter_contact_details else 'Change',
              current_service.url_for('.service_letter_contact_details'),
              permissions=['manage_service','manage_api_keys']
          )
          }}
        {% endcall %}

        {% call settings_row(if_has_permission='letter') %}
          {{ text_field('Letter branding') }}
          {{ text_field(current_service.letter_branding) }}
          {{ edit_field(
            'Change',
            current_service.url_for('.request_letter_branding'),
            permissions=['manage_service']
          )}}
        {% endcall %}

        {% if current_user.platform_admin %}
          {% call settings_row(if_has_permission='letter') %}
            {{ text_field('Postage') }}
              {% set postage = {'first': 'First class only', 'second': 'Second class only'} %}
              {{ text_field(postage[current_service.postage]) }}
            {{ edit_field(
                'Change',
                current_service.url_for('.service_set_postage'),
                permissions=['manage_service']
            )
            }}
          {% endcall %}
        {% endif %}

      {% endcall %}
    </div>

    {% if current_service.trial_mode %}
      <h2 class="heading-medium">Your service is in trial mode</h2>

      <ul class='list list-bullet'>
        <li>you can only send messages to yourself</li>
        <li>you can add people to your team, then you can send messages to them too</li>
        <li>you can only send 50 messages per day</li>
      </ul>

      <p>
        {% if current_user.has_permissions('manage_service') %}
          To remove these restrictions
          <a href="{{ current_service.url_for('.request_to_go_live') }}">request to go live</a>.
        {% else %}
          Your service manager can ask to have these restrictions removed.
        {% endif %}
        </p>

    {% else %}
      <h2 class="heading-medium">Your service is live</h2>

      <p>
        You can send up to
        {{ "{:,}".format(current_service.message_limit) }} messages
        per day.
      </p>
      <p>
        Problems or comments?
        <a href="{{ url_for('main.support') }}">Give feedback</a>.
      </p>

    {% endif %}

    {% if current_user.platform_admin %}

      <h2 class="heading-medium">Platform admin settings</h2>
      {% call mapping_table(
        caption='Settings',
        field_headings=['Label', 'Value', 'Action'],
        field_headings_visible=False,
        caption_visible=False
      ) %}
        {% call row() %}
          {{ text_field('Organisation')}}
          {{ optional_text_field(current_service.organisation_name) }}
          {{ edit_field('Change', current_service.url_for('.link_service_to_organisation')) }}
        {% endcall %}
        {% call row() %}
          {{ text_field('Organisation type')}}
          {{ optional_text_field(
            (current_service.organisation_type or '')|title
          ) }}
          {{ edit_field('Change', current_service.url_for('.set_organisation_type')) }}
        {% endcall %}
        {% call row() %}
          {{ text_field('Free text message allowance')}}
          {{ text_field('{:,}'.format(current_service.free_sms_fragment_limit)) }}
          {{ edit_field('Change', current_service.url_for('.set_free_sms_allowance')) }}
        {% endcall %}
        {% call row() %}
          {{ text_field('Email branding' )}}
          {{ text_field(current_service.email_branding.name or 'GOV.UK') }}
          {{ edit_field('Change', current_service.url_for('.service_set_email_branding')) }}
        {% endcall %}
        {% call row() %}
          {{ text_field('Letter branding')}}
          {{ text_field(current_service.letter_branding) }}
          {{ edit_field('Change', current_service.url_for('.set_letter_branding')) }}
        {% endcall %}
        {% call row() %}
          {{ text_field('Data retention')}}
          {% call field() %}
              {{ current_service.data_retention | join(', ', attribute='notification_type') }}
          {% endcall %}
          {{ edit_field('Change', current_service.url_for('.data_retention')) }}
        {% endcall %}
      {% endcall %}

      <ul>
        <li class="bottom-gutter">
          <a href="{{ current_service.url_for('.service_switch_live') }}" class="button">
            {{ 'Make service live' if current_service.trial_mode else 'Revert service to trial mode' }}
          </a>
        </li>
        <li class="bottom-gutter">
          <a href="{{ current_service.url_for('.service_switch_research_mode') }}" class="button">
            {{ 'Take service out of research mode' if current_service.research_mode else 'Put into research mode' }}
          </a>
        </li>
        <li class="bottom-gutter">
          <a href="{{ current_service.url_for('.service_switch_can_send_email') }}" class="button">
            {{ 'Stop sending emails' if 'email' in current_service.permissions else 'Allow to send emails' }}
          </a>
        </li>
        <li class="bottom-gutter">
          <a href="{{ current_service.url_for('.service_switch_can_send_sms') }}" class="button">
            {{ 'Stop sending sms' if 'sms' in current_service.permissions else 'Allow to send sms' }}
          </a>
        </li>
        {% if 'sms' in current_service.permissions %}
          <li class="bottom-gutter">
          {% if not current_service.has_permission('inbound_sms') %}
            <a href="{{ current_service.url_for('.service_set_inbound_number', set_inbound_sms=True) }}" class="button">
              Allow inbound sms
            </a>
          {% endif %}
          </li>
        {% endif %}
        {% if 'letter' in current_service.permissions %}
          <li class="bottom-gutter">
            <a href="{{ current_service.url_for('.service_switch_can_send_precompiled_letter') }}" class="button">
              {{ 'Stop sending precompiled letters' if 'precompiled_letter' in current_service.permissions else 'Allow to send precompiled letters' }}
            </a>
          </li>
        {% endif %}
        <li class="bottom-gutter">
          <a href="{{ current_service.url_for('.service_switch_email_auth') }}" class="button">
            {{ 'Stop user auth type editing' if 'email_auth' in current_service.permissions else 'Allow user auth type editing' }}
          </a>
        </li>
        <li class="bottom-gutter">
           <a href="{{ current_service.url_for('.service_switch_can_upload_document') }}" class="button">
             {{ 'Stop uploading documents' if 'upload_document' in current_service.permissions else 'Allow to upload documents' }}
           </a>
        </li>
        <li class="bottom-gutter">
           <a href="{{ current_service.url_for('.service_switch_can_edit_folders') }}" class="button">
             {{ 'Stop editing folders' if 'edit_folders' in current_service.permissions else 'Allow to edit folders' }}
           </a>
        </li>
        {% if current_service.active %}
          <li class="bottom-gutter">
            <a href="{{ current_service.url_for('.archive_service') }}" class="button">
              Archive service
            </a>
          </li>
          <li class="bottom-gutter">
            <a href="{{ current_service.url_for('.suspend_service') }}" class="button">
              Suspend service
            </a>
          </li>
        {% else %}
          <li class="bottom-gutter">
            <a href="{{ current_service.url_for('.resume_service') }}" class="button">
              Resume service
            </a>
          </li>
        {% endif %}
      </ul>

    {% endif %}

{% endblock %}
}
